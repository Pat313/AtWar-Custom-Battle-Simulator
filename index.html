<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Battle Simulator</title>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="css/style.css"/>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>
  <!-- Header bar -->
  <header id="header-bar">
    <h1>Custom Battle Simulator</h1>
  </header>

<!-- ===== NAVBAR ===== -->
<nav id="top-nav">
  <div class="nav-inner">
  <button id="settings-button" class="btn-apply">Settings ‚öôÔ∏è</button>
  <label id="unit-set-label">Unit Set:</label>
  <select id="unit-set-picker" class="select2-unit-sets" style="width:160px;"></select>
  <!-- Error bar -->
<div id="error-bar" class="error-bar"></div>
    </div>
</nav>

  <!-- Main layout: left = units, middle = stacks, right = controls + results -->
  <div class="container">
    
    <!-- Units list -->
    <div id="units-container">
      <div id="units-list-header">
        <input type="text" id="units-list-search" placeholder="üîç Search units..." />
</div>
      <ul id="units-list"></ul>
    </div>

    <!-- Stacks (scrollable) -->
    <div id="stack-container">
      <div id="stack-header">
</div>
      <!-- Add stack INSIDE this panel; keeps behavior because class is the same -->
      <button id="add-stack-button" class="stack-add">+ Add New Stack</button>
    </div>

    <!-- Right column: run controls + results -->
    <div id="right-panel">
      <div id="right-controls">
        <label for="times" class="control-label">Number of Simulations</label>
        <input type="number" id="times" value="10000" min="1" />
        <button id="submit-button">Run Simulation</button>
<span id="loading-icon" style="display:none;">
  <img src="UI/res/spinner-icon.gif" title="Running simulation‚Ä¶" />
</span>
      </div>

      <pre id="battle-results">Simulation Result:</pre>
    </div>
  </div>

  <!-- Templates (kept identical so JS behavior stays intact) -->
  <template id="unitrow-template">
    <tr data-unitid="$id">
      <td><input type="number" class="quantity-cell" value="$count" min="1"></td>
      <td><img src="$image" draggable="true" data-unitid="$id"> $name</td>
      <td class="attack-cell">$attack</td>
      <td class="defence-cell">$defence</td>
      <td class="hp-cell">$hp</td>
      <td class="critical-cell">$critical</td>
      <td class="defbonus-cell"><span class="v-mid">$defbonus</span></td>
    </tr>
  </template>

  <template id="defbonus-template">
    <span class="defbonus-item">
      <img src="$image" title="$name"> ($bonus)
    </span>
  </template>

  <template id="stack-template">
  <div class="stack" data-name="$name">
    <span class="stack-title">$name</span>
    <span class="stack-delete">X</span>

    <!-- top row: check-boxes -->
    <div class="stack-options-top">
      <label><input type="checkbox" name="is-defending"> Defending</label>
      <label><input type="checkbox" name="in-city" disabled> In City</label>
      <label><input type="checkbox" name="in-defence-line" disabled> In Defence Line</label>
      <label class="stack-option"><input type="checkbox" name="enable-upgrades" checked> Enable upgrades</label>
      <span class="gear-icon modal-close" title="Customize upgrades">‚öôÔ∏è</span>
<span class="upgrade-count-label">0 / ${TOTAL_UPGRADES}</span>  
    </div>

<!-- upgrade modal -->
<div class="upgrade-modal" style="display:none;">
  <div class="modal-card">
    <div class="modal-header">
      <span class="modal-title">Choose Upgrades</span>
      <button class="modal-close">√ó</button>
    </div>

    <div class="modal-body">
      <div class="upgrade-list">
        <div class="upgrade-group">
  <h3>
    Global
    <input type="checkbox" class="select-all-global" title="Select all/deselect all" checked>
  </h3>
  <div class="upgrade-items global-upgrades"></div>
</div>

<div class="upgrade-group">
  <h3>
    General
    <input type="checkbox" class="select-all-general" title="Select all/deselect all" checked>
  </h3>
  <div class="upgrade-items general-upgrades"></div>
</div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-apply">Apply</button>
    </div>
  </div>
</div>

    <!-- second row: selects -->
    <div class="stack-options-bottom">
      <label>Strategy:
        <select class="select2-strategies" name="strategy" style="width:150px;"></select>
      </label>
      <label>Allies:
        <select class="select2-allies" multiple="multiple" style="width:200px;"></select>
      </label>
    </div>

    <!-- table -->
    <table>
      <thead>
        <tr>
          <th>Quantity</th>
          <th>Name</th>
          <th>Attack</th>
          <th>Defense</th>
          <th>HP</th>
          <th>Crit.</th>
          <th>Defense&nbsp;Bonus</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</template>

<!-- settings modal -->
<div id="settings-modal" class="settings-modal" style="display:none">
  <div class="modal-card">
      <div class="modal-header">
      <span class="modal-title">Choose Upgrades</span>
      <button class="modal-close">√ó</button>
    </div>
      <div class="modal-body">
        <label><input type="checkbox" class="sort-check"> Sort units alphabetically</label><br>
        <label>Default unit count <input type="number" class="default-count" min="1"></label><br>
        <label>All units key <input type="text" class="units-key"></label>
      </div>
      <div class="modal-footer">
        <button class="btn-apply">Apply</button>
      </div>
  </div>
</div>

<!-- unit loader -->
<script src="units/index.js"></script>
<script src="scripts/unitLoader.js"></script>
<script>
  const file = localStorage.getItem('aw_unitsFile') || '000 - Default Units.js';
  const script = document.createElement('script');
  script.id = 'units-script';
  script.src = 'units/' + encodeURIComponent(file);
  script.type = 'text/javascript';
  document.head.appendChild(script);
</script>

<!-- other scripts -->
  <script src="scripts/strats.js"></script>
  <script src="scripts/generalUpgrades.js"></script>
  <script src="scripts/upgrades.js"></script>
  <script src="scripts/buildingBonus.js"></script>

<script>
/* ---------- wait until units, strats, upgrades etc. are ready ---------- */
function bootstrapWhenReady() {
  if (typeof units === 'undefined' ||
      typeof strats === 'undefined' ||
      typeof upgrades === 'undefined' ||
      typeof generalUpgrades === 'undefined') {
    setTimeout(bootstrapWhenReady, 30);   // poll again soon
    return;
  }

  // all globals are present ‚Äì load the rest of the app
  const sim = document.createElement('script');
  sim.src = 'scripts/sim.js';
  sim.onload = () => {
    document.head.appendChild(Object.assign(document.createElement('script'), { src: 'UI/settings-modal.js' }));
    document.head.appendChild(Object.assign(document.createElement('script'), { src: 'UI/upgrades-modal.js' }));
  };
  document.head.appendChild(sim);
}

// start polling once the DOM is ready
document.addEventListener('DOMContentLoaded', bootstrapWhenReady);
</script>

</body>
</html>
